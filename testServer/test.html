<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Test Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            opacity: 0.8;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #connect {
            background-color: #2196F3;
        }
        #disconnect {
            background-color: #f44336;
        }
        .message-area {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        .message.system {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        .message.received {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        .message.sent {
            background-color: #fff3e0;
            color: #ef6c00;
            text-align: right;
        }
        .input-area {
            display: flex;
            margin-bottom: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        #send {
            margin-left: 10px;
        }
        .status {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        .status.disconnected {
            background-color: #ffebee;
            color: #c62828;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Socket.IO Test Client</h1>
        
        <div class="status" id="status">Disconnected</div>
        
        <div class="controls">
            <button id="connect">Connect to Server</button>
            <button id="disconnect" disabled>Disconnect</button>
            <button id="sendCustomEvent">Send Custom Event</button>
            <button id="testAck" disabled>ACK Test</button>
            <button id="sendBinary" disabled>Send Binary</button>
            <button id="testBinaryAck" disabled>Binary ACK Test</button>
        </div>
        
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Enter message..." disabled>
            <button id="send" disabled>Send</button>
        </div>
        
        <div class="message-area" id="messageArea">
            <div class="message system">Ready to connect to server...</div>
        </div>
        
        <div>
            <h3>Server URL:</h3>
            <input type="text" id="serverUrl" value="http://localhost:3000" style="width: 100%; margin-bottom: 10px;">
        </div>
    </div>
    
    <!-- Socket.IO Client Library (Local) -->
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        // DOM Elements
        const statusElement = document.getElementById('status');
        const messageArea = document.getElementById('messageArea');
        const messageInput = document.getElementById('messageInput');
        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const sendBtn = document.getElementById('send');
        const sendCustomEventBtn = document.getElementById('sendCustomEvent');
        const testAckBtn = document.getElementById('testAck');
        const sendBinaryBtn = document.getElementById('sendBinary');
        const testBinaryAckBtn = document.getElementById('testBinaryAck');
        const serverUrlInput = document.getElementById('serverUrl');
        
        // Socket instance
        let socket;
        
        // Add message to message area
        function addMessage(text, type = 'system') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            messageArea.appendChild(messageDiv);
            messageArea.scrollTop = messageArea.scrollHeight;
        }
        
        // Update connection status
        function updateStatus(connected) {
            if (connected) {
                statusElement.className = 'status connected';
                statusElement.textContent = 'Connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
                messageInput.disabled = false;
                sendCustomEventBtn.disabled = false;
                testAckBtn.disabled = false;
                sendBinaryBtn.disabled = false;
                testBinaryAckBtn.disabled = false;
                addMessage('Connected to server');
            } else {
                statusElement.className = 'status disconnected';
                statusElement.textContent = 'Disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
                messageInput.disabled = true;
                sendCustomEventBtn.disabled = true;
                testAckBtn.disabled = true;
                sendBinaryBtn.disabled = true;
                testBinaryAckBtn.disabled = true;
                addMessage('Disconnected from server');
            }
        }
        
        // æ£€æŸ¥Socket.IOæ˜¯å¦æ­£ç¡®åŠ è½½
        function checkSocketIO() {
            if (typeof io === 'undefined') {
                addMessage('âŒ Socket.IO library not loaded correctly!', 'system');
                connectBtn.disabled = true;
                return false;
            } else {
                addMessage('âœ… Socket.IO library loaded successfully', 'system');
                return true;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥Socket.IO
        window.addEventListener('load', () => {
            checkSocketIO();
        });
        
        // Connect to server
        connectBtn.addEventListener('click', () => {
            const serverUrl = serverUrlInput.value;
            
            addMessage(`Connecting to ${serverUrl}...`);
            
            try {
                if (typeof io === 'undefined') {
                    throw new Error('Socket.IO library not loaded');
                }
                
                socket = io(serverUrl, {
                    transports: ['polling'],
                    timeout: 5000
                });
                
                // Connection event
                socket.on('connect', () => {
                    updateStatus(true);
                    addMessage(`Connected with socket ID: ${socket.id}`);
                });
                
                // Disconnect event
                socket.on('disconnect', (reason) => {
                    updateStatus(false);
                    addMessage(`Disconnected: ${reason}`);
                });
                
                // Welcome message
                socket.on('welcome', (data, callback) => {
                    addMessage(`Welcome message: ${JSON.stringify(data)}`, 'received');
                    
                    // å‘é€ACKå“åº”
                    if (callback && typeof callback === 'function') {
                        callback({ success: true, message: 'Welcome received from HTML client', clientId: socket.id });
                    }
                });
                
                // User connected event
                socket.on('userConnected', (data, callback) => {
                    addMessage(`User joined: ${data.socketId}`, 'system');
                    
                    // å‘é€ACKå“åº”
                    if (callback && typeof callback === 'function') {
                        callback({ success: true, message: 'UserConnected received from HTML client', clientId: socket.id });
                    }
                });
                
                // User disconnected event
                socket.on('userDisconnected', (data) => {
                    addMessage(`User left: ${data.socketId}`, 'system');
                });
                
                // Chat message event
                socket.on('chatMessage', (data) => {
                    const message = `${data.sender}: ${data.message}`;
                    addMessage(message, 'received');
                });
                
                // Heartbeat event
                socket.on('heartbeat', (data) => {
                    addMessage(`Heartbeat: ${data.timestamp}`, 'system');
                });
                
                // Binary event
        socket.on('binaryEvent', (data) => {
            if (data.binaryData) {
                // æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ®
                addMessage(`Binary message from ${data.sender}: Size ${data.binaryData.length} bytes, Text: ${data.text || 'No text'}`, 'received');
                
                // æ¯”è¾ƒäºŒè¿›åˆ¶æ•°æ®
                if (data.text && data.text.includes('testData')) {
                    // è¿™æ˜¯ç”¨äºæ¯”è¾ƒçš„æµ‹è¯•æ•°æ®
                    addMessage('ğŸ” å¼€å§‹æ¯”è¾ƒäºŒè¿›åˆ¶æ•°æ®...', 'system');
                    
                    // åˆ›å»ºç›¸åŒçš„æµ‹è¯•æ•°æ®ç”¨äºæ¯”è¾ƒ
                    const expectedData = new Uint8Array(1024);
                    for (let i = 0; i < expectedData.length; i++) {
                        expectedData[i] = i % 256;
                    }
                    
                    // æ¯”è¾ƒæ”¶åˆ°çš„æ•°æ®ä¸é¢„æœŸæ•°æ®
                    let isEqual = true;
                    if (data.binaryData.length === expectedData.length) {
                        for (let i = 0; i < expectedData.length; i++) {
                            if (data.binaryData[i] !== expectedData[i]) {
                                isEqual = false;
                                break;
                            }
                        }
                    } else {
                        isEqual = false;
                    }
                    
                    if (isEqual) {
                        addMessage('âœ… äºŒè¿›åˆ¶æ•°æ®å®Œå…¨åŒ¹é…ï¼', 'system');
                    } else {
                        addMessage('âŒ äºŒè¿›åˆ¶æ•°æ®ä¸åŒ¹é…ï¼', 'system');
                        addMessage(`   é¢„æœŸå¤§å°: ${expectedData.length} bytes, å®é™…å¤§å°: ${data.binaryData.length} bytes`, 'system');
                    }
                }
                
                // å¦‚æœæ˜¯ä»è‡ªå·±å‘é€çš„
                if (data.sender === socket.id) {
                    addMessage('âœ“ This binary message was sent by me', 'system');
                }
            } else {
                // æ™®é€šæ•°æ®
                addMessage(`Binary event from ${data.sender}: ${JSON.stringify(data)}`, 'received');
            }
        });
                
                // Error event
                socket.on('error', (error) => {
                    addMessage(`Error: ${error.message}`, 'system');
                });
                
            } catch (error) {
                addMessage(`Connection error: ${error.message}`, 'system');
                addMessage(`Socket.IO status: ${typeof io}`, 'system');
            }
        });
        
        // Disconnect from server
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
            }
        });
        
        // Send message
        sendBtn.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message && socket) {
                addMessage(`Sent: ${message}`, 'sent');
                
                // Send with ACK
                socket.emit('chatMessage', { message: message }, (ack) => {
                    addMessage(`ACK received: ${JSON.stringify(ack)}`, 'system');
                });
                
                messageInput.value = '';
            }
        });
        
        // Send message on Enter key
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });
        
        // Send custom event
        sendCustomEventBtn.addEventListener('click', () => {
            if (socket) {
                const customData = {
                    timestamp: new Date().toISOString(),
                    random: Math.random(),
                    message: 'Custom event from HTML client'
                };
                
                addMessage(`Sending custom event: ${JSON.stringify(customData)}`, 'sent');
                
                // Send with ACK
                socket.emit('customEvent', customData, (ack) => {
                    addMessage(`Custom event ACK: ${JSON.stringify(ack)}`, 'system');
                });
            }
        });
        
        // ACK test button event listener
        testAckBtn.addEventListener('click', async () => {
            if (socket) {
                addMessage('ğŸ”„ Starting concurrent ACK test...', 'system');
                
                // Test parameters
                const testCount = 10; // Test 10 concurrent ACKs
                let completedCount = 0;
                let successCount = 0;
                let failureCount = 0;
                const startTime = Date.now();
                
                for (let i = 0; i < testCount; i++) {
                    const testIndex = i;
                    
                    // Send with ACK
                    socket.emit('customEvent', {
                        testIndex: testIndex,
                        message: `ACK Test ${testIndex}`,
                        timestamp: Date.now()
                    }, (ack) => {
                        completedCount++;
                        
                        if (ack && ack.success) {
                            successCount++;
                            addMessage(`âœ… ACK ${testIndex} success: ${JSON.stringify(ack)}`, 'system');
                        } else {
                            failureCount++;
                            addMessage(`âŒ ACK ${testIndex} failed: ${JSON.stringify(ack)}`, 'system');
                        }
                        
                        // All tests completed
                        if (completedCount === testCount) {
                            const endTime = Date.now();
                            const duration = (endTime - startTime) / 1000;
                            
                            addMessage(`ğŸ“Š Concurrent ACK test completed: Total ${testCount}, Success ${successCount}, Failed ${failureCount}, Duration ${duration.toFixed(2)}s`, 'system');
                        }
                    });
                    
                    // Small delay to avoid too many requests at once
                    await new Promise(resolve => setTimeout(resolve, 5));
                }
            }
        });
        
        // Send binary message button event listener
        sendBinaryBtn.addEventListener('click', () => {
            if (socket) {
                // åˆ›å»ºæ¨¡æ‹ŸäºŒè¿›åˆ¶æ•°æ®
                const binaryData = new Uint8Array(1024); // 1KBäºŒè¿›åˆ¶æ•°æ®
                for (let i = 0; i < binaryData.length; i++) {
                    binaryData[i] = i % 256; // å¡«å……æ•°æ®: 0-255å¾ªç¯
                }
                
                const textMessage = 'testData: HTMLå®¢æˆ·ç«¯å‘é€çš„äºŒè¿›åˆ¶æµ‹è¯•æ•°æ®';
                
                addMessage(`ğŸ“¤ Sending binary data: Size ${binaryData.length} bytes, Text: ${textMessage}`, 'sent');
                
                // å‘é€äºŒè¿›åˆ¶æ¶ˆæ¯
                socket.emit('binaryEvent', {
                    binaryData: binaryData,
                    text: textMessage,
                    timestamp: Date.now()
                }, (ack) => {
                    if (ack && ack.success) {
                        addMessage(`âœ… Binary message ACK: ${JSON.stringify(ack)}`, 'system');
                    } else {
                        addMessage(`âŒ Binary message failed: ${JSON.stringify(ack)}`, 'system');
                    }
                });
            }
        });
        
        // Binary ACK test button event listener
        testBinaryAckBtn.addEventListener('click', async () => {
            if (socket) {
                addMessage('ğŸ”„ Starting binary ACK test...', 'system');
                
                // åˆ›å»ºæ¨¡æ‹ŸäºŒè¿›åˆ¶æ•°æ®
                const binaryData = new Uint8Array(512); // 512 bytes binary data
                for (let i = 0; i < binaryData.length; i++) {
                    binaryData[i] = Math.floor(Math.random() * 256); // éšæœºæ•°æ®
                }
                
                // å‘é€å¸¦ACKçš„äºŒè¿›åˆ¶æ¶ˆæ¯
                socket.emit('binaryAckTest', {
                    binaryData: binaryData,
                    text: 'Binary ACK test from HTML client',
                    timestamp: Date.now()
                }, (ack) => {
                    if (ack && ack.result === 'success') {
                        addMessage(`âœ… Binary ACK test success: ${JSON.stringify(ack)}`, 'system');
                    } else {
                        addMessage(`âŒ Binary ACK test failed: ${JSON.stringify(ack)}`, 'system');
                    }
                });
            }
        });
    </script>
</body>
</html>
